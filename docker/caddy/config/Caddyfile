{
	#acme_ca https://acme-staging-v02.api.letsencrypt.org/directory
	email jakob@edvardsson.tech
}
(authentik) {
	# Always forward outpost path to actual outpost
	reverse_proxy /outpost.goauthentik.io/* authentik_server:9000

	# Forward authentication to outpost
	forward_auth authentik_server:9000 {
		uri /outpost.goauthentik.io/auth/caddy

		# Capitalization of the headers is important, otherwise they will be empty
		copy_headers X-Authentik-Username X-Authentik-Groups X-Authentik-Email X-Authentik-Name X-Authentik-Uid X-Authentik-Jwt X-Authentik-Meta-Jwks X-Authentik-Meta-Outpost X-Authentik-Meta-Provider X-Authentik-Meta-App X-Authentik-Meta-Version
	}
}
*.edvardsson.tech {
	tls {
		dns cloudflare {
			zone_token {env.CF_ZONE_TOKEN}
			api_token {env.CF_API_TOKEN}
		}
		resolvers 1.1.1.1
	}
	@jellyfin host jellyfin.edvardsson.tech
	handle @jellyfin {
		reverse_proxy binhex-jellyfin:8096
	}
	@immich host immich.edvardsson.tech
	handle @immich {
		reverse_proxy immich_server:2283
	}
	@authentik host authentik.edvardsson.tech
	handle @authentik {
		reverse_proxy authentik_server:9000
	}
	@homeassistant host homeassistant.edvardsson.tech
	handle @homeassistant {
		@blocked {
			path *service-worker.js
		}
		respond @blocked 404
		import authentik
		reverse_proxy 10.0.0.43:8123
	}
}
